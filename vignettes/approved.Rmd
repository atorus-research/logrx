---
title: "Logging Unapproved Package and Function Use"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{approved}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(timber)
```

## 1. Create a named list containing the functions approved for use for each package. If all functions for a package are approved for use, list "All".

```{r}
approved_pkgs <- list(haven = "read_sas",
                      dplyr = "All")
approved_pkgs
```

## 2. Pass the named list through `build_approved()` to build your tibble.

```{r}
build_approved <- function(.x, .y){
   
  all <- tibble::tibble(function_name = getNamespaceExports(.x),
                        library = paste0("package:", .x))

  if (.y[1] %in% c("All", "all")){
    all
  } else{
    all[all$function_name %in% .y,]
  }
  
}

approved <- purrr::map2_df(names(approved_pkgs), approved_pkgs, build_approved)

approved

```

## 3. Save as `approved.rds` wherever you like.

```{r}
dir <- tempdir()
saveRDS(approved, file.path(dir, "approved.rds"))
```

## 4. Update the `timber.approved` option to point to your `approved.rds` location. We recommend setting this in your `.Rprofile`.

```{r}
options(timber.approved = file.path(dir, "approved.rds"))
```

## 5. `timber` will take it from there. When each program is executed, packages and functions will be compared to `approved.rds` and if any unapproved use is found, it will be logged within the "Unapproved Package and Functions" section.

## Example

Let's write a simple script summarizing mean mpg from mtcars. We save this as `mpg.R` in the temporary directory `dir` and `axecute()` it.

```{r}
library(dplyr)

results <- mtcars %>%
   group_by(cyl) %>%
   summarize(mean = mean(mpg)) %>%
   mutate(label = "Mean MPG")

results %>%
   tidyr::pivot_wider(names_from = cyl, values_from = mean, id_cols = label)
```

```{r echo = FALSE}
# write this to the temp directory so we have a script to axecute

text <- 'library(dplyr)

results <- mtcars %>%
   group_by(cyl) %>%
   summarize(mean = mean(mpg)) %>%
   mutate(label = "Mean MPG")

results %>%
   tidyr::pivot_wider(names_from = cyl, values_from = mean, id_cols = label)'
   
fileConn <- file(file.path(dir,"mpg.R"))
writeLines(text, fileConn)
close(fileConn)

```

```{r results='hide'}
axecute(file.path(dir,"mpg.R"))
```

Here we have the log. If you scroll to the "Unapproved Package and Functions" section, we will see we used `library()` and `mean()` from `package:base` and `pivot_wider` from `package:tidyr`.  We did not include any base or tidyr functions in our approved list, so this has been logged!

|  {package:base} library, mean
|  {package:tidyr} pivot_wider

```{r echo = FALSE}
cat(readLines(file.path(dir, "mpg.log")), sep = '\n')
```

```{r cleanup, echo = FALSE}
unlink(dir, recursive = TRUE)
```
